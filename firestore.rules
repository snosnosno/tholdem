rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ====================
    //  Helper Functions
    // ====================
    function isSignedIn() {
      return request.auth != null;
    }

    function isTD() {
      // Check if the user is signed in and if their role in the 'staff' collection is 'TD'.
      return isSignedIn() && get(/databases/$(database)/documents/staff/$(request.auth.uid)).data.role == 'TD';
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // ====================
    //  Collection Rules
    // ====================

    // Settings: Readable by signed-in users, writable only by TDs.
    match /settings/{docId} {
      allow read: if isSignedIn();
      allow write: if isTD();
    }

    // Staff: Readable by signed-in users. Writable only by TDs.
    match /staff/{staffId} {
      allow read: if isSignedIn();
      allow write: if isTD();
    }

    // Tables: Readable by signed-in users, writable only by TDs.
    match /tables/{tableId} {
      allow read: if isSignedIn();
      allow write: if isTD();
    }

    // WorkLogs: Readable by signed-in users.
    // A user can only create their own work log.
    // Only TDs can update or delete logs.
    match /workLogs/{logId} {
      allow read: if isSignedIn();
      allow create: if isOwner(request.resource.data.staffId);
      allow update, delete: if isTD();
    }

    // Participants: Readable by signed-in users, writable only by TDs.
    match /participants/{participantId} {
      allow read: if isSignedIn();
      allow write: if isTD();
    }
    
    // Announcements: Readable by signed-in users, writable only by TDs.
    match /announcements/{announcementId} {
        allow read: if isSignedIn();
        allow write: if isTD();
    }
    
    // Logs (internal): Accessible only by TDs.
    match /logs/{logId} {
        allow read, write: if isTD();
    }
    
    // Legacy rules for compatibility
    match /tournaments/{any} {
      allow read, write: if isTD();
    }
    match /notices/{any} {
      allow read: if true;
      allow write: if isTD();
    }
  }
}

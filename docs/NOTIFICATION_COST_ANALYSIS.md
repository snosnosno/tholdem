# 알림 시스템 비용 분석

**문서 버전**: 1.0.0
**분석 일자**: 2025-10-15
**프로젝트**: T-HOLDEM v0.2.3

---

## 📊 비용 분석 요약

### 예상 월간 비용 (100명 기준)

| 서비스 | 무료 할당량 | 예상 사용량 | 예상 비용 |
|--------|------------|-------------|-----------|
| **Cloud Functions** | 200만 호출 | ~15만 호출 | **무료** |
| **FCM 푸시 알림** | 무제한 무료 | ~10만 건 | **무료** |
| **Firestore 읽기** | 5만 건 | ~30만 건 | **$0.18** |
| **Firestore 쓰기** | 2만 건 | ~15만 건 | **$0.23** |
| **Firestore 저장** | 1GB | ~100MB | **무료** |
| **네트워크 송신** | 10GB | ~1GB | **무료** |
| **총 월간 비용** | - | - | **~$0.41** |

**💰 결론**: 100명 사용자 기준 **월 약 $0.41 (약 550원)** 수준의 매우 저렴한 비용

---

## 🔥 Firebase Cloud Functions 비용

### 1. 가격 구조 (2025년 기준)

**무료 할당량 (Spark 플랜)**:
- 호출: 200만 건/월
- 컴퓨팅 시간: 40만 GB-초/월
- 네트워크 송신: 5GB/월

**유료 비용 (Blaze 플랜 - 무료 할당량 초과 시)**:
- 호출: $0.40 / 100만 건
- 컴퓨팅 시간(256MB): $0.000000463 / GB-초
- 네트워크 송신: $0.12 / GB

### 2. Functions 실행 시간 분석 (로그 기반)

| Function | 평균 실행 시간 | 메모리 | GB-초 비용 |
|----------|---------------|--------|-----------|
| `onWorkTimeChanged` | 5,085ms (~5초) | 256MB | 0.00125 GB-초 |
| `onApplicationStatusChanged` | ~2,000ms | 256MB | 0.00050 GB-초 |
| `onApplicationSubmitted` | ~1,500ms | 256MB | 0.00038 GB-초 |
| `broadcastNewJobPosting` | ~3,000ms | 256MB | 0.00075 GB-초 |
| `sendJobPostingAnnouncement` | ~2,500ms | 256MB | 0.00063 GB-초 |

**실행 시간 최적화 필요**: `onWorkTimeChanged`가 5초로 가장 느림 (staffId 파싱, 시간 변환 등)

### 3. 월간 예상 호출 횟수 (100명 기준)

**시나리오 가정**:
- 활성 사용자: 100명
- 월간 공고: 50개
- 월간 지원서: 200건
- 월간 확정: 100건
- 월간 근무시간 변경: 300건

| Function | 월간 호출 | 연간 호출 |
|----------|-----------|-----------|
| `broadcastNewJobPosting` | 50회 | 600회 |
| `onApplicationSubmitted` | 200회 | 2,400회 |
| `onApplicationStatusChanged` | 200회 | 2,400회 |
| `onWorkTimeChanged` | 300회 | 3,600회 |
| `sendJobPostingAnnouncement` | 100회 | 1,200회 |
| **총계** | **850회** | **10,200회** |

**무료 할당량 대비**: 850회 / 200만회 = **0.04%** ✅ 무료 범위 내

### 4. Functions 비용 계산

#### 호출 비용
- 월간 호출: 850회
- 연간 호출: 10,200회
- **비용**: **무료** (200만 건 할당량 내)

#### 컴퓨팅 시간 비용
```
월간 총 GB-초 계산:
- onWorkTimeChanged: 300회 × 0.00125 GB-초 = 0.375 GB-초
- onApplicationStatusChanged: 100회 × 0.00050 GB-초 = 0.050 GB-초
- onApplicationSubmitted: 200회 × 0.00038 GB-초 = 0.076 GB-초
- broadcastNewJobPosting: 50회 × 0.00075 GB-초 = 0.038 GB-초
- sendJobPostingAnnouncement: 100회 × 0.00063 GB-초 = 0.063 GB-초

월간 총 GB-초 = 0.602 GB-초
연간 총 GB-초 = 7.224 GB-초
```

**비용**: **무료** (40만 GB-초 할당량 내)

---

## 📱 FCM (Firebase Cloud Messaging) 비용

### 가격 구조
- **FCM 푸시 알림**: **완전 무료** ✅
- 전송 건수 제한 없음
- 모든 플랫폼(Android, iOS, Web) 무료

### 월간 예상 푸시 알림 (100명 기준)

| 알림 타입 | 월간 발송 | 수신자 수 | 총 알림 수 |
|----------|-----------|-----------|-----------|
| 신규 공고 | 50건 | 100명 | 5,000건 |
| 지원서 제출 | 200건 | 1명 | 200건 |
| 지원 확정/취소 | 200건 | 1명 | 200건 |
| 근무시간 변경 | 300건 | 1명 | 300건 |
| 공고 공지 | 100건 | 10명 | 1,000건 |
| **총계** | - | - | **6,700건** |

**비용**: **무료** ✅

---

## 🔥 Firestore 비용

### 1. 가격 구조

**무료 할당량 (Spark 플랜)**:
- 저장: 1GB
- 읽기: 50,000건/일 (150만건/월)
- 쓰기: 20,000건/일 (60만건/월)
- 삭제: 20,000건/일 (60만건/월)

**유료 비용 (Blaze 플랜 - 무료 할당량 초과 시)**:
- 저장: $0.18 / GB / 월
- 읽기: $0.036 / 10만 건
- 쓰기: $0.108 / 10만 건
- 삭제: $0.012 / 10만 건

### 2. 알림 문서 저장 비용

**월간 알림 문서 생성**:
- 신규 공고 알림: 50건 × 100명 = 5,000건
- 지원서 알림: 200건
- 지원 상태 알림: 200건
- 근무시간 변경 알림: 300건
- 공고 공지: 100건 × 10명 = 1,000건
- **총 생성**: **6,700건/월**

**문서 크기**:
- 평균 알림 문서: ~500 bytes
- 월간 저장: 6,700건 × 500 bytes = **3.35 MB**
- 연간 저장 (90일 보관): 3.35 MB × 3개월 = **10 MB**

**저장 비용**: **무료** (1GB 할당량 내)

### 3. Firestore 읽기/쓰기 비용 (100명 기준)

#### 쓰기 작업
```
알림 생성 (월간):
- 신규 알림 문서: 6,700건
- 알림 읽음 처리: 5,000건 (약 75% 읽음)
- 알림 삭제: 2,000건
총 쓰기: 13,700건/월
```

**무료 할당량 대비**: 13,700 / 600,000 = **2.3%** ✅
**초과 비용 (만약 초과 시)**: 0건 × $0.108 / 10만 = **$0**

#### 읽기 작업
```
알림 조회 (월간):
- 알림 목록 조회: 100명 × 10회/일 × 30일 = 30,000건
- 실시간 구독: 100명 × 50회/일 × 30일 = 150,000건
- 알림 상세 조회: 5,000건
총 읽기: 185,000건/월
```

**무료 할당량 대비**: 185,000 / 1,500,000 = **12.3%** ✅
**초과 비용 (만약 초과 시)**: 0건 × $0.036 / 10만 = **$0**

---

## 📊 사용자 규모별 비용 예측

### 1. 소규모 (100명)

| 항목 | 월간 사용량 | 비용 |
|------|-------------|------|
| Cloud Functions | 850회 호출 | **무료** |
| FCM 푸시 | 6,700건 | **무료** |
| Firestore 읽기 | 185,000건 | **무료** |
| Firestore 쓰기 | 13,700건 | **무료** |
| Firestore 저장 | 10MB | **무료** |
| **총 비용** | - | **$0** |

### 2. 중규모 (500명)

| 항목 | 월간 사용량 | 무료 초과 | 비용 |
|------|-------------|-----------|------|
| Cloud Functions | 4,250회 호출 | 없음 | **무료** |
| FCM 푸시 | 33,500건 | 없음 | **무료** |
| Firestore 읽기 | 925,000건 | 없음 | **무료** |
| Firestore 쓰기 | 68,500건 | 8,500건 | **$0.09** |
| Firestore 저장 | 50MB | 없음 | **무료** |
| **총 비용** | - | - | **$0.09** |

### 3. 대규모 (1,000명)

| 항목 | 월간 사용량 | 무료 초과 | 비용 |
|------|-------------|-----------|------|
| Cloud Functions | 8,500회 호출 | 없음 | **무료** |
| FCM 푸시 | 67,000건 | 없음 | **무료** |
| Firestore 읽기 | 1,850,000건 | 350,000건 | **$0.13** |
| Firestore 쓰기 | 137,000건 | 77,000건 | **$0.08** |
| Firestore 저장 | 100MB | 없음 | **무료** |
| **총 비용** | - | - | **$0.21** |

### 4. 엔터프라이즈 (5,000명)

| 항목 | 월간 사용량 | 무료 초과 | 비용 |
|------|-------------|-----------|------|
| Cloud Functions | 42,500회 호출 | 없음 | **무료** |
| FCM 푸시 | 335,000건 | 없음 | **무료** |
| Firestore 읽기 | 9,250,000건 | 7,750,000건 | **$2.79** |
| Firestore 쓰기 | 685,000건 | 85,000건 | **$0.92** |
| Firestore 저장 | 500MB | 없음 | **무료** |
| **총 비용** | - | - | **$3.71** |

---

## 💡 비용 최적화 전략

### 1. Firestore 읽기 최적화 ✅ (이미 적용됨)

**현재 구현**:
- ✅ `onSnapshot` 실시간 구독으로 효율적 업데이트
- ✅ 페이지네이션 (최근 20개만 조회)
- ✅ 읽지 않은 알림만 필터링

**추가 최적화 가능**:
- 알림 문서 캐싱 (React Query, SWR)
- 오프라인 모드 지원 (Firestore Offline Persistence)

### 2. Firestore 쓰기 최적화

**현재 구현**:
- ✅ 배치 쓰기 (`batch.commit()`)
- ✅ 중복 알림 방지

**추가 최적화 가능**:
- 읽은 알림 자동 아카이빙 (90일 후 삭제)
- 알림 통합 (같은 타입 5분 이내 알림 합치기)

### 3. Cloud Functions 최적화

**현재 상태**:
- ⚠️ `onWorkTimeChanged`: 5초 (최적화 필요)
- ✅ 다른 Functions: 1-3초 (양호)

**최적화 방안**:
```typescript
// 1. staffId 파싱 캐싱
const staffIdCache = new Map<string, string>();

function extractUserId(staffId: string): string {
  if (staffIdCache.has(staffId)) {
    return staffIdCache.get(staffId)!;
  }
  const userId = staffId.split('_')[0];
  staffIdCache.set(staffId, userId);
  return userId;
}

// 2. Firestore 쿼리 병렬화
const [jobPosting, staff] = await Promise.all([
  db.collection('jobPostings').doc(eventId).get(),
  db.collection('users').doc(actualUserId).get(),
]);

// 3. FCM 전송 비동기 처리
admin.messaging().send(fcmMessage).catch(err => {
  functions.logger.error('FCM 전송 실패', err);
});
```

**예상 개선**: 5초 → **2초** (60% 향상)

### 4. FCM 전송 최적화 ✅ (이미 적용됨)

**현재 구현**:
- ✅ 멀티캐스트 전송 (500명 단위 배치)
- ✅ 실패 시 재시도 로직
- ✅ 토큰 검증

---

## 📈 비용 증가 시나리오

### 경고 임계값 설정

| 지표 | 경고 (Yellow) | 위험 (Red) |
|------|--------------|-----------|
| 월간 비용 | > $5 | > $20 |
| Firestore 읽기 | > 500만 건 | > 1,000만 건 |
| Firestore 쓰기 | > 100만 건 | > 200만 건 |
| Functions 호출 | > 100만 건 | > 150만 건 |

### 비용 급증 원인 및 대응

**1. 스팸/악용**:
- 원인: 봇이 반복적으로 알림 생성
- 대응: Rate Limiting, CAPTCHA

**2. 무한 루프**:
- 원인: Functions가 서로 트리거
- 대응: 조건 검증, 이벤트 필터링

**3. 데이터 폭증**:
- 원인: 알림 삭제 안 함
- 대응: 90일 자동 아카이빙

---

## 🔍 비용 모니터링

### Firebase Console 확인 항목

**1. Functions 사용량**:
- Console > Functions > 사용량 탭
- 호출 횟수, 실행 시간, 오류율

**2. Firestore 사용량**:
- Console > Firestore > 사용량 탭
- 읽기/쓰기/삭제 건수

**3. FCM 사용량**:
- Console > Cloud Messaging > Reports
- 전송 건수, 성공률, 오픈율

### 비용 알림 설정

```bash
# Firebase CLI로 예산 알림 설정
firebase projects:addfirebase:budgetalert \
  --amount 10 \
  --email your-email@example.com
```

---

## 📊 실제 비용 추적 (2025-10-15 기준)

### 현재 사용량
- 사용자: ~10명 (테스트 중)
- 월간 Functions 호출: ~850회
- 월간 FCM 전송: ~100건
- 월간 Firestore 읽기: ~5,000건
- 월간 Firestore 쓰기: ~500건

### 현재 비용
**총 비용: $0** ✅ (무료 범위 내)

---

## 💰 결론 및 권장 사항

### 1. 비용 효율성 ⭐⭐⭐⭐⭐

**T-HOLDEM 알림 시스템은 매우 비용 효율적입니다**:
- 100명: **무료**
- 500명: **$0.09/월**
- 1,000명: **$0.21/월**
- 5,000명: **$3.71/월**

### 2. 확장성 ✅

Firebase는 자동 확장되므로 사용자 급증에도 안정적:
- 트래픽 스파이크 대응 자동
- 별도 인프라 관리 불필요
- 성능 저하 없음

### 3. 권장 사항

**단기 (현재)**:
- ✅ 현재 구현 유지 (비용 효율적)
- ✅ 무료 할당량 범위 내 운영
- ✅ 월간 비용 모니터링

**중기 (사용자 500명 이상)**:
- `onWorkTimeChanged` 성능 최적화 (5초 → 2초)
- 알림 자동 아카이빙 구현 (90일 후 삭제)
- Firestore 캐싱 전략 도입

**장기 (사용자 5,000명 이상)**:
- 알림 통합 로직 (중복 방지)
- CDN 캐싱 활용
- 읽기 작업 최적화 (인덱싱, 쿼리 개선)

---

*최종 업데이트: 2025년 10월 15일*
*분석 기준: Firebase 2025년 가격 정책*

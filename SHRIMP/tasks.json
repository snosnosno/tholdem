{
  "tasks": [
    {
      "id": "2eab2049-e22d-4a15-b2a2-7bbfe594c65a",
      "name": "staffId/userId 매핑 유틸리티 생성",
      "description": "스태프 식별자를 통일하는 유틸리티 함수를 생성하여 staffId와 userId 불일치 문제 해결",
      "notes": "기존 코드와의 호환성을 위해 staffId, userId, id 순서로 체크",
      "status": "pending",
      "dependencies": [],
      "createdAt": "2025-08-23T11:49:15.381Z",
      "updatedAt": "2025-08-23T11:49:15.381Z",
      "relatedFiles": [
        {
          "path": "app2/src/utils/staffIdMapper.ts",
          "type": "CREATE",
          "description": "새로운 유틸리티 파일"
        }
      ],
      "implementationGuide": "app2/src/utils/staffIdMapper.ts 파일 생성\\n\\nexport function getStaffIdentifier(staff: any): string {\\n  return staff.staffId || staff.userId || staff.id || '';\\n}\\n\\nexport function matchStaffIdentifier(log: any, staffIdentifiers: string[]): boolean {\\n  const logId = log.staffId || log.userId || '';\\n  return staffIdentifiers.includes(logId);\\n}\\n\\n이 유틸리티를 useEnhancedPayroll과 DetailEditModal에서 import하여 사용",
      "verificationCriteria": "staffId와 userId가 다른 경우에도 정상적으로 매칭되는지 확인",
      "analysisResult": "스태프 탭에서 수정한 시간이 정산 탭에 반영되지 않고, 날짜별 역할 구분이 안되는 문제를 해결. staffId/userId 매핑 통일, WorkLog 필터링 로직 개선, 역할별 정산 분리 구현"
    },
    {
      "id": "f795eac2-345f-42cb-9943-5cab95bab1e8",
      "name": "useEnhancedPayroll 필터링 로직 수정",
      "description": "정산 훅에서 WorkLog 필터링 시 staffId/userId 통일 로직 적용 및 역할 정보 처리 개선",
      "notes": "staffIds 변수명을 staffIdentifiers로 변경하여 의도 명확화",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "2eab2049-e22d-4a15-b2a2-7bbfe594c65a"
        }
      ],
      "createdAt": "2025-08-23T11:49:15.381Z",
      "updatedAt": "2025-08-23T11:49:15.381Z",
      "relatedFiles": [
        {
          "path": "app2/src/hooks/useEnhancedPayroll.ts",
          "type": "TO_MODIFY",
          "description": "필터링 로직 수정",
          "lineStart": 46,
          "lineEnd": 226
        }
      ],
      "implementationGuide": "app2/src/hooks/useEnhancedPayroll.ts 수정\\n\\n1. Line 46-48: staffIds 생성 로직 변경\\nconst staffIdentifiers = useMemo(() => {\\n  return confirmedStaff.map(staff => getStaffIdentifier(staff));\\n}, [confirmedStaff]);\\n\\n2. Line 69: 필터링 로직 개선\\nlet filtered = workLogs.filter(log => matchStaffIdentifier(log, staffIdentifiers));\\n\\n3. Line 223-226: 날짜별 역할 매칭 강화\\nconst staffWorkLogs = filteredWorkLogs.filter(log => \\n  matchStaffIdentifier(log, [getStaffIdentifier(staff)]) && \\n  log.date === staff.date\\n);",
      "verificationCriteria": "confirmedStaff의 userId와 workLog의 staffId가 다른 경우에도 정산 데이터가 표시되는지 확인",
      "analysisResult": "스태프 탭에서 수정한 시간이 정산 탭에 반영되지 않고, 날짜별 역할 구분이 안되는 문제를 해결. staffId/userId 매핑 통일, WorkLog 필터링 로직 개선, 역할별 정산 분리 구현"
    },
    {
      "id": "0b12bed4-5cdc-4ae5-b558-1d52bb415bc6",
      "name": "WorkTimeEditor 역할 정보 보완",
      "description": "WorkLog 생성/수정 시 역할 정보가 누락되지 않도록 보완",
      "notes": "role 필드가 반드시 포함되도록 보장",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "2eab2049-e22d-4a15-b2a2-7bbfe594c65a"
        }
      ],
      "createdAt": "2025-08-23T11:49:15.381Z",
      "updatedAt": "2025-08-23T11:49:15.381Z",
      "relatedFiles": [
        {
          "path": "app2/src/components/WorkTimeEditor.tsx",
          "type": "TO_MODIFY",
          "description": "역할 정보 추가",
          "lineStart": 196,
          "lineEnd": 210
        }
      ],
      "implementationGuide": "app2/src/components/WorkTimeEditor.tsx 수정\\n\\n1. Line 196-206: WorkLog 생성 시 역할 정보 추가\\nconst createInput: WorkLogCreateInput = {\\n  staffId: getStaffIdentifier(workLog),\\n  eventId: workLog.eventId || '',\\n  staffName: workLog.staffName || '',\\n  date: workLog.date,\\n  role: workLog.role || staff?.role || 'dealer',\\n  type: 'schedule',\\n  scheduledStartTime: finalStartTime,\\n  scheduledEndTime: finalEndTime,\\n  status: 'scheduled'\\n};\\n\\n2. confirmedStaff에서 역할 정보 가져오기 로직 추가",
      "verificationCriteria": "WorkLog 생성 시 role 필드가 올바르게 저장되는지 확인",
      "analysisResult": "스태프 탭에서 수정한 시간이 정산 탭에 반영되지 않고, 날짜별 역할 구분이 안되는 문제를 해결. staffId/userId 매핑 통일, WorkLog 필터링 로직 개선, 역할별 정산 분리 구현"
    },
    {
      "id": "4074907d-46f6-41d3-9628-0e6f17be67f8",
      "name": "DetailEditModal 필터링 개선",
      "description": "정산 상세 모달에서 과도한 역할 필터링 제거하고 날짜별 모든 WorkLog 표시",
      "notes": "role 필터링을 제거하여 모든 역할의 WorkLog 표시",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "2eab2049-e22d-4a15-b2a2-7bbfe594c65a"
        }
      ],
      "createdAt": "2025-08-23T11:49:15.381Z",
      "updatedAt": "2025-08-23T11:49:15.381Z",
      "relatedFiles": [
        {
          "path": "app2/src/components/payroll/DetailEditModal.tsx",
          "type": "TO_MODIFY",
          "description": "필터링 로직 개선",
          "lineStart": 69,
          "lineEnd": 85
        }
      ],
      "implementationGuide": "app2/src/components/payroll/DetailEditModal.tsx 수정\\n\\n1. Line 69-72: 필터링 조건 완화\\nconst staffWorkLogs = realTimeWorkLogs.filter(log => {\\n  const isSameStaff = matchStaffIdentifier(log, [getStaffIdentifier(staff)]);\\n  return isSameStaff;\\n});\\n\\n2. 역할별 그룹화 로직 추가\\nconst workLogsByRole = staffWorkLogs.reduce((acc, log) => {\\n  const role = log.role || 'unknown';\\n  if (!acc[role]) acc[role] = [];\\n  acc[role].push(log);\\n  return acc;\\n}, {});\\n\\n3. UI에 역할별 근무 내역 표시",
      "verificationCriteria": "정산 상세 모달에서 23일 floor, 24일 dealer, 25일 dealer가 모두 표시되는지 확인",
      "analysisResult": "스태프 탭에서 수정한 시간이 정산 탭에 반영되지 않고, 날짜별 역할 구분이 안되는 문제를 해결. staffId/userId 매핑 통일, WorkLog 필터링 로직 개선, 역할별 정산 분리 구현"
    },
    {
      "id": "1703be0d-b967-4dfa-8636-4fb56df6f86b",
      "name": "역할별 정산 데이터 분리 구현",
      "description": "같은 스태프가 여러 역할로 근무한 경우 역할별로 정산 데이터를 분리하여 표시",
      "notes": "날짜별 역할이 다른 경우를 정확히 처리",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "2eab2049-e22d-4a15-b2a2-7bbfe594c65a"
        },
        {
          "taskId": "f795eac2-345f-42cb-9943-5cab95bab1e8"
        }
      ],
      "createdAt": "2025-08-23T11:49:15.381Z",
      "updatedAt": "2025-08-23T11:49:15.381Z",
      "relatedFiles": [
        {
          "path": "app2/src/hooks/useEnhancedPayroll.ts",
          "type": "TO_MODIFY",
          "description": "역할별 분리 로직",
          "lineStart": 159,
          "lineEnd": 186
        }
      ],
      "implementationGuide": "app2/src/hooks/useEnhancedPayroll.ts 수정\\n\\n1. Line 159-186: staffRoleMap 로직 개선\\nconst staffRoleMap = new Map();\\nfilteredWorkLogs.forEach(log => {\\n  const staffId = getStaffIdentifier(log);\\n  const role = log.role || 'unknown';\\n  const key = `${staffId}_${role}`;\\n  \\n  if (!staffRoleMap.has(key)) {\\n    staffRoleMap.set(key, {\\n      staffId: staffId,\\n      staffName: log.staffName,\\n      role: role,\\n      workLogs: []\\n    });\\n  }\\n  staffRoleMap.get(key).workLogs.push(log);\\n});\\n\\n2. 역할별 정산 계산 분리",
      "verificationCriteria": "정산 탭에서 floor와 dealer 역할이 별도로 표시되고 각각의 시간이 정확히 계산되는지 확인",
      "analysisResult": "스태프 탭에서 수정한 시간이 정산 탭에 반영되지 않고, 날짜별 역할 구분이 안되는 문제를 해결. staffId/userId 매핑 통일, WorkLog 필터링 로직 개선, 역할별 정산 분리 구현"
    },
    {
      "id": "4e414e58-4ed4-49c0-95d8-701ed6a73d30",
      "name": "실시간 동기화 검증 및 최적화",
      "description": "WorkTimeEditor에서 수정한 내용이 정산 탭에 즉시 반영되도록 실시간 동기화 검증",
      "notes": "Firebase 실시간 동기화가 정상 작동하는지 확인",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "0b12bed4-5cdc-4ae5-b558-1d52bb415bc6"
        }
      ],
      "createdAt": "2025-08-23T11:49:15.381Z",
      "updatedAt": "2025-08-23T11:49:15.381Z",
      "relatedFiles": [
        {
          "path": "app2/src/hooks/useUnifiedWorkLogs.ts",
          "type": "TO_MODIFY",
          "description": "동기화 로직 검증",
          "lineStart": 247,
          "lineEnd": 263
        }
      ],
      "implementationGuide": "1. useUnifiedWorkLogs의 onSnapshot 리스너 동작 확인\\n2. 디바운싱 적용으로 과도한 리렌더링 방지\\n3. 로깅 추가로 데이터 흐름 추적\\n\\nlogger.debug('WorkLog updated', {\\n  workLogId: id,\\n  updates: updates,\\n  timestamp: new Date()\\n});",
      "verificationCriteria": "스태프 탭에서 시간 수정 후 1초 이내에 정산 탭에 반영되는지 확인",
      "analysisResult": "스태프 탭에서 수정한 시간이 정산 탭에 반영되지 않고, 날짜별 역할 구분이 안되는 문제를 해결. staffId/userId 매핑 통일, WorkLog 필터링 로직 개선, 역할별 정산 분리 구현"
    }
  ]
}